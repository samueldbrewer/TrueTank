{% extends "base.html" %}

{% block title %}Job Board - TrueTank{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block content %}
<div class="job-board-container">
    <div class="board-header">
        <h2>Daily Job Scheduler</h2>
        <div class="header-controls">
            <div class="date-navigation">
                <button id="prev-day" class="btn btn-sm btn-secondary">‚Äπ Previous</button>
                <input type="date" id="selected-date" class="date-picker" value="">
                <button id="next-day" class="btn btn-sm btn-secondary">Next ‚Ä∫</button>
                <button id="today-btn" class="btn btn-sm btn-primary">Today</button>
            </div>
            <div class="board-actions">
                <a href="{{ url_for('create_ticket') }}" class="btn btn-secondary">+ Create Ticket</a>
                <button id="refresh-board" class="btn btn-primary">üîÑ Refresh</button>
            </div>
        </div>
    </div>
    
    <div class="truck-scheduler">
        <!-- Pending Column (Left) -->
        <div class="pending-column">
            <div class="column-header">
                <h3>Pending Jobs</h3>
                <span id="pending-count" class="badge">0</span>
            </div>
            
            <!-- Search Bar -->
            <div class="search-controls">
                <input type="text" id="search-pending" class="search-input" placeholder="Search tickets...">
            </div>
            
            <!-- Sort Controls -->
            <div class="sort-controls">
                <label for="sort-pending">Sort by:</label>
                <select id="sort-pending" class="sort-select">
                    <option value="oldest">Oldest first</option>
                    <option value="due_date">Due date</option>
                    <option value="priority">Priority</option>
                    <option value="customer">Customer name</option>
                </select>
            </div>
            
            <div id="pending-tickets" class="ticket-list" 
                 ondrop="handleDrop(event)" 
                 ondragover="handleDragOver(event)">
                <!-- Pending tickets will be loaded here -->
            </div>
        </div>
        
        <!-- Truck Columns (Right) -->
        <div class="truck-columns" id="truck-columns">
            <!-- Truck columns will be dynamically generated here -->
        </div>
    </div>
    
    <!-- Team Assignment Modal -->
    <div id="team-assignment-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Team Member</h3>
                <span class="close" onclick="closeTeamModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Select team member for <span id="modal-truck-name"></span> on <span id="modal-date"></span>:</p>
                <select id="team-member-select">
                    <option value="">No assignment</option>
                    {% for member in team_members %}
                    <option value="{{ member.id }}">{{ member.first_name }} {{ member.last_name }} ({{ member.position }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTeamModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTeamAssignment()">Assign</button>
            </div>
        </div>
    </div>

    <!-- Truck Route Map Modal -->
    <div id="truck-map-modal" class="modal" style="display: none;">
        <div class="modal-content map-modal-content">
            <div class="modal-header">
                <h3>üó∫Ô∏è Route Map - <span id="map-truck-name"></span></h3>
                <span class="close" onclick="closeTruckMapModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="map-container">
                    <div id="truck-map" style="height: 500px; width: 100%;"></div>
                </div>
                <div id="route-summary" class="route-summary">
                    <h4>üìç Route Summary for <span id="summary-date"></span></h4>
                    <div id="route-jobs-list" class="route-jobs-list">
                        <!-- Jobs will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTruckMapModal()">Close</button>
                <button class="btn btn-success" onclick="exportRoute()">üì§ Export Directions</button>
            </div>
        </div>
    </div>

</div>

<style>
.job-board-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem;
}

.board-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #ecf0f1;
}

.board-header h2 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

.header-controls {
    display: flex;
    gap: 2rem;
    align-items: center;
    flex-wrap: wrap;
}

.date-navigation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.date-picker {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.search-controls {
    margin-bottom: 1rem;
}

.search-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
    box-sizing: border-box;
}

.search-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.sort-controls label {
    font-size: 0.9rem;
    color: #666;
}

.sort-select {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

.board-actions {
    display: flex;
    gap: 0.5rem;
    margin-left: auto;
}

.truck-scheduler {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 1rem;
    height: calc(100vh - 200px);
    overflow: hidden;
}

.pending-column {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 1rem;
    overflow-y: auto;
}

/* Ensure pending tickets have white background */
.pending-column .ticket-card {
    background-color: #ffffff;
    background: white;
}

.column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ddd;
}

.column-header h3 {
    margin: 0;
    color: #2c3e50;
}

.badge {
    background: #3498db;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.truck-columns {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    overflow-x: auto;
    overflow-y: hidden;
}

.truck-column {
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 8px;
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.truck-header {
    background: #34495e;
    color: white;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.truck-title-section h4 {
    margin: 0;
    font-size: 1.1rem;
}

.truck-title-section .truck-info {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.truck-actions {
    display: flex;
    gap: 0.5rem;
}

.truck-action-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    padding: 0.4rem 0.6rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.truck-action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-1px);
}

.map-btn {
    background: rgba(52, 152, 219, 0.3);
}

.map-btn:hover {
    background: rgba(52, 152, 219, 0.5);
}

.team-btn {
    background: rgba(39, 174, 96, 0.3);
}

.team-btn:hover {
    background: rgba(39, 174, 96, 0.5);
}

.team-assignment {
    background: #ecf0f1;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #ddd;
    font-size: 0.9rem;
    color: #7f8c8d;
}

.ticket-list {
    flex: 1;
    padding: 1rem;
    min-height: 300px;
}

.ticket-card {
    background-color: #ffffff !important;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.5rem;
    margin-bottom: 0.35rem;
    cursor: move;
    transition: all 0.2s ease;
    border-left: 3px solid #3498db;
    min-height: 60px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.ticket-card:hover {
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.ticket-card.priority-urgent {
    border-left-color: #e74c3c;
}

.ticket-card.priority-high {
    border-left-color: #f39c12;
}

.ticket-card.priority-medium {
    border-left-color: #3498db;
}

.ticket-card.priority-low {
    border-left-color: #95a5a6;
}

.ticket-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.ticket-id {
    font-weight: bold;
    color: #2c3e50;
    font-size: 0.9rem;
}

.priority-badge {
    padding: 0.15rem 0.3rem;
    border-radius: 3px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-urgent {
    background: #e74c3c;
    color: white;
}

.priority-high {
    background: #f39c12;
    color: white;
}

.priority-medium {
    background: #3498db;
    color: white;
}

.priority-low {
    background: #95a5a6;
    color: white;
}

.ticket-customer {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.ticket-service {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.ticket-due {
    color: #95a5a6;
    font-size: 0.75rem;
    margin-top: 0.2rem;
}

.ticket-actions {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #ecf0f1;
}

.btn-action {
    background: #3498db;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.btn-action:hover {
    background: #2980b9;
}

.drop-zone {
    border: 2px dashed #3498db;
    background: rgba(52, 152, 219, 0.1);
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
    color: #3498db;
    margin: 0.5rem 0;
}

.drop-zone.drag-over {
    background: rgba(52, 152, 219, 0.2);
    border-color: #2980b9;
}

.no-results {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 2rem 1rem;
    border: 2px dashed #ecf0f1;
    border-radius: 6px;
    margin: 1rem 0;
}

/* Drag and Drop Enhancements */
.ghost-card {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 25%, transparent 25%, transparent 50%, rgba(52, 152, 219, 0.1) 50%, rgba(52, 152, 219, 0.1) 75%, transparent 75%);
    background-size: 8px 8px;
    border: 2px dashed #3498db;
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3498db;
    font-style: italic;
    opacity: 0.8;
    transition: all 0.2s ease;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { 
        opacity: 0.6;
        transform: scale(0.98);
    }
    50% { 
        opacity: 0.9;
        transform: scale(1.02);
    }
}

.ticket-list.drag-over {
    background-color: rgba(52, 152, 219, 0.05);
    border-radius: 6px;
}

.ticket-card.ghost-placeholder {
    opacity: 0.5;
    background: linear-gradient(135deg, #ecf0f1 25%, transparent 25%, transparent 50%, #ecf0f1 50%, #ecf0f1 75%, transparent 75%);
    background-size: 10px 10px;
    border: 2px dashed #bdc3c7;
    color: #7f8c8d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-style: italic;
    min-height: 80px;
}

/* Compact Ticket Cards for Truck Columns */
.ticket-card-compact {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.5rem;
    margin-bottom: 0.35rem;
    cursor: move;
    transition: all 0.2s ease;
    border-left: 3px solid #3498db;
    min-height: 45px;
}

.ticket-card-compact:hover {
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.ticket-card-compact.priority-urgent {
    border-left-color: #e74c3c;
}

.ticket-card-compact.priority-high {
    border-left-color: #f39c12;
}

.ticket-card-compact.priority-medium {
    border-left-color: #3498db;
}

.ticket-card-compact.priority-low {
    border-left-color: #95a5a6;
}

.ticket-card-compact.dragging {
    opacity: 0.5;
    transform: rotate(3deg);
}

.compact-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.compact-job-id {
    font-weight: bold;
    color: #2c3e50;
    font-size: 0.9rem;
}

.compact-service {
    color: #7f8c8d;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.btn-compact-action {
    background: #3498db;
    color: white;
    border: none;
    width: 18px;
    height: 18px;
    border-radius: 3px;
    font-size: 0.8rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    line-height: 1;
}

.btn-compact-action:hover {
    background: #2980b9;
}

/* Pending Card Styles - Match compact design but with more info */
.pending-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.pending-job-id {
    font-weight: bold;
    color: #2c3e50;
    font-size: 0.9rem;
}

.pending-customer {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 0.2rem;
    font-size: 0.85rem;
}

.pending-service {
    color: #7f8c8d;
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.pending-address {
    color: #95a5a6;
    font-size: 0.75rem;
    margin-bottom: 0.15rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-style: italic;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #ecf0f1;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 1rem;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding: 1rem;
    border-top: 1px solid #ecf0f1;
}


/* Map Modal Styles */
.modal {
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-modal-content {
    width: 95%;
    max-width: 1000px;
    max-height: 90vh;
    margin: 0;
}

.route-summary {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.route-summary h4 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.route-jobs-list {
    max-height: 200px;
    overflow-y: auto;
}

.route-job-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    border-left: 3px solid #3498db;
}

.route-job-item.priority-urgent {
    border-left-color: #e74c3c;
}

.route-job-item.priority-high {
    border-left-color: #f39c12;
}

.route-job-item.priority-medium {
    border-left-color: #3498db;
}

.route-job-item.priority-low {
    border-left-color: #95a5a6;
}

.job-order {
    background: #3498db;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.job-details {
    flex: 1;
}

.job-time {
    font-weight: bold;
    color: #2c3e50;
    margin-right: 0.5rem;
}

.job-service {
    color: #34495e;
    margin-right: 0.5rem;
}

.job-customer {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.job-address {
    color: #95a5a6;
    font-size: 0.85rem;
    margin-top: 0.25rem;
}

@media (max-width: 768px) {
    .truck-scheduler {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
    }
    
    .truck-columns {
        grid-template-columns: 1fr;
    }
    
    .header-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .board-actions {
        margin-left: 0;
    }
    
    .truck-actions {
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .truck-action-btn {
        font-size: 0.7rem;
        padding: 0.3rem 0.5rem;
    }
    
    .map-modal-content {
        width: 98%;
        margin: 1rem auto;
    }
    
    #truck-map {
        height: 300px !important;
    }
}
</style>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// Global variables
let currentDate = new Date().toISOString().split('T')[0];
let currentTruckId = null;
let trucks = [];
let teamAssignments = {};
let allPendingTickets = []; // Store all pending tickets for search functionality
let currentSearchTerm = '';
let currentSortBy = 'oldest';

// Click vs Drag detection
let mouseDownTime = 0;
let mouseDownPos = {x: 0, y: 0};
let isDragging = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize date picker with today's date
    document.getElementById('selected-date').value = currentDate;
    
    // Event listeners
    document.getElementById('selected-date').addEventListener('change', function() {
        currentDate = this.value;
        loadJobBoard();
    });
    
    document.getElementById('prev-day').addEventListener('click', function() {
        const date = new Date(currentDate);
        date.setDate(date.getDate() - 1);
        currentDate = date.toISOString().split('T')[0];
        document.getElementById('selected-date').value = currentDate;
        loadJobBoard();
    });
    
    document.getElementById('next-day').addEventListener('click', function() {
        const date = new Date(currentDate);
        date.setDate(date.getDate() + 1);
        currentDate = date.toISOString().split('T')[0];
        document.getElementById('selected-date').value = currentDate;
        loadJobBoard();
    });
    
    document.getElementById('today-btn').addEventListener('click', function() {
        currentDate = new Date().toISOString().split('T')[0];
        document.getElementById('selected-date').value = currentDate;
        loadJobBoard();
    });
    
    document.getElementById('sort-pending').addEventListener('change', function() {
        currentSortBy = this.value;
        loadJobBoard();
    });
    
    document.getElementById('search-pending').addEventListener('input', function() {
        currentSearchTerm = this.value.toLowerCase();
        filterAndDisplayPendingTickets();
    });
    
    document.getElementById('refresh-board').addEventListener('click', function() {
        loadJobBoard();
    });
    
    // Load initial data
    loadJobBoard();
});

function loadJobBoard() {
    const url = `/api/job-board?date=${currentDate}&sort=${currentSortBy}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            trucks = data.trucks;
            allPendingTickets = data.pending_tickets;
            currentSortBy = data.sort_by;
            
            // Load persisted team assignments
            teamAssignments = {};
            if (data.team_assignments) {
                Object.keys(data.team_assignments).forEach(truckId => {
                    const assignment = data.team_assignments[truckId];
                    teamAssignments[truckId] = {
                        id: assignment.team_member_id,
                        name: assignment.team_member_name
                    };
                });
            }
            
            // Update sort dropdown
            document.getElementById('sort-pending').value = currentSortBy;
            
            // Filter and display pending tickets
            filterAndDisplayPendingTickets();
            
            renderTruckColumns(data.trucks, data.truck_schedules);
            
            // If a truck map is currently open, refresh it with updated data
            if (currentMapTruckId && document.getElementById('truck-map-modal').style.display === 'flex') {
                console.log('Refreshing open map with updated data');
                const truckInfo = trucks.find(t => t.id == currentMapTruckId);
                const assignedTeamMember = teamAssignments[currentMapTruckId];
                const truckTickets = data.truck_schedules[currentMapTruckId] || [];
                
                // Re-initialize the map with fresh data
                initializeMapWithTickets(truckInfo, assignedTeamMember, truckTickets);
            }
        })
        .catch(error => {
            console.error('Error loading job board:', error);
            alert('Failed to load job board data');
        });
}

function filterAndDisplayPendingTickets() {
    let filteredTickets = allPendingTickets;
    
    // Apply search filter
    if (currentSearchTerm) {
        filteredTickets = allPendingTickets.filter(ticket => {
            const searchableText = [
                ticket.job_id,
                ticket.customer_name,
                ticket.service_type,
                ticket.service_description,
                ticket.priority,
                ticket.status
            ].join(' ').toLowerCase();
            
            return searchableText.includes(currentSearchTerm);
        });
    }
    
    renderPendingTickets(filteredTickets);
    updatePendingCount(filteredTickets.length);
}

function renderPendingTickets(tickets) {
    const container = document.getElementById('pending-tickets');
    container.innerHTML = '';
    
    if (tickets.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = currentSearchTerm ? 'No tickets match your search' : 'No pending tickets';
        container.appendChild(noResults);
        return;
    }
    
    tickets.forEach(ticket => {
        const ticketCard = createTicketCard(ticket);
        container.appendChild(ticketCard);
    });
}

function renderTruckColumns(trucks, schedules) {
    const container = document.getElementById('truck-columns');
    container.innerHTML = '';
    
    trucks.forEach(truck => {
        const column = createTruckColumn(truck, schedules[truck.id] || []);
        container.appendChild(column);
    });
}

function createTicketCard(ticket, context = 'pending') {
    const card = document.createElement('div');
    card.dataset.ticketId = ticket.id;
    card.dataset.context = context;
    
    if (context === 'truck') {
        // Compact truck view - thinner card with just job ID and service type
        card.className = `ticket-card-compact priority-${ticket.priority}`;
        card.draggable = true; // Enable dragging for truck tickets
        card.innerHTML = `
            <div class="compact-header">
                <span class="compact-job-id">${ticket.job_id}</span>
                <button class="btn-compact-action" onclick="event.stopPropagation(); moveTicketToPending(${ticket.id})" title="Move back to Pending">‚Üê</button>
            </div>
            <div class="compact-service">${ticket.service_type || 'Service'}</div>
        `;
        // Add drag event listeners for truck tickets
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        // Add click handler for expansion
        card.addEventListener('mousedown', handleCardMouseDown);
        card.addEventListener('mouseup', handleCardMouseUp);
        card.addEventListener('click', handleCardClick);
    } else {
        // Full pending view - detailed card with all information
        card.className = `ticket-card priority-${ticket.priority}`;
        card.draggable = true; // Enable dragging for pending tickets to assign to trucks
        
        let dueDate = '';
        if (ticket.requested_service_date) {
            const due = new Date(ticket.requested_service_date);
            dueDate = `<div class="ticket-due">Due: ${due.toLocaleDateString()}</div>`;
        }
        
        card.innerHTML = `
            <div class="pending-header">
                <span class="pending-job-id">${ticket.job_id}</span>
                <span class="priority-badge priority-${ticket.priority}">${ticket.priority}</span>
            </div>
            <div class="pending-customer">${ticket.customer_name || 'No customer'}</div>
            <div class="pending-address">${ticket.customer_address || 'No address'}</div>
            <div class="pending-service">${ticket.service_type || 'No service type'}</div>
            ${dueDate}
        `;
        // Add drag event listeners for pending tickets
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        // Add click handler for expansion
        card.addEventListener('mousedown', handleCardMouseDown);
        card.addEventListener('mouseup', handleCardMouseUp);
        card.addEventListener('click', handleCardClick);
    }
    
    return card;
}

function createTruckColumn(truck, tickets) {
    const column = document.createElement('div');
    column.className = 'truck-column';
    column.dataset.truckId = truck.id;
    
    const assignedMember = teamAssignments[truck.id] || null;
    const teamDisplay = assignedMember ? 
        `Assigned: ${assignedMember.name}` : 
        'Click to assign team member';
    
    column.innerHTML = `
        <div class="truck-header">
            <div class="truck-title-section">
                <h4>${truck.truck_number}</h4>
                <div class="truck-info">${truck.make} ${truck.model}</div>
            </div>
            <div class="truck-actions">
                <button class="truck-action-btn map-btn" onclick="openTruckMap(${truck.id}, '${truck.truck_number}')" title="View route map">
                    üó∫Ô∏è Map
                </button>
                <button class="truck-action-btn team-btn" onclick="openTeamModal(${truck.id}, '${truck.truck_number}')" title="Assign team member">
                    üë• Team
                </button>
            </div>
        </div>
        <div class="team-assignment">${teamDisplay}</div>
        <div class="ticket-list" 
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)"
             data-truck-id="${truck.id}">
            ${tickets.length === 0 ? '<div class="drop-zone">Drop tickets here</div>' : ''}
        </div>
    `;
    
    // Add existing tickets
    const ticketList = column.querySelector('.ticket-list');
    tickets.forEach((ticket, index) => {
        const ticketCard = createTicketCard(ticket, 'truck');
        ticketCard.dataset.routePosition = index;
        ticketList.appendChild(ticketCard);
    });
    
    return column;
}

function updatePendingCount(count) {
    document.getElementById('pending-count').textContent = count;
}

// Drag and Drop Functions
let draggedTicket = null;
let currentGhostCard = null;
let targetPosition = null;

function handleDragStart(e) {
    draggedTicket = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    
    // Create ghost cards in all ticket lists
    createGhostCards();
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    draggedTicket = null;
    
    // Remove all ghost cards
    removeGhostCards();
    
    // Remove drag-over class from all lists
    document.querySelectorAll('.ticket-list').forEach(list => {
        list.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const ticketList = e.target.closest('.ticket-list');
    if (!ticketList) return;
    
    const pendingColumn = ticketList.closest('.pending-column');
    const sourcePendingColumn = draggedTicket?.closest('.pending-column');
    
    // Remove drag-over from all other lists and hide their ghost cards
    document.querySelectorAll('.ticket-list').forEach(list => {
        if (list !== ticketList) {
            list.classList.remove('drag-over');
            const ghostCard = list.querySelector('.ghost-card');
            if (ghostCard) ghostCard.style.display = 'none';
        }
    });
    
    // Don't show drag-over effects when trying to reorder within pending column
    if (pendingColumn && sourcePendingColumn) {
        return; // Don't show any drag feedback for pending-to-pending
    }
    
    // Add drag-over visual feedback to current list
    ticketList.classList.add('drag-over');
    
    // Show and position ghost card (but not for pending column reordering)
    if (!(pendingColumn && sourcePendingColumn)) {
        updateGhostCardPosition(e, ticketList);
    }
}

function createGhostCards() {
    document.querySelectorAll('.ticket-list').forEach(ticketList => {
        // Remove existing ghost card if any
        const existingGhost = ticketList.querySelector('.ghost-card');
        if (existingGhost) existingGhost.remove();
        
        // Create new ghost card
        const ghostCard = document.createElement('div');
        ghostCard.className = 'ghost-card';
        ghostCard.textContent = 'Drop ticket here';
        ghostCard.style.display = 'none';
        
        // Add to beginning of list
        ticketList.insertBefore(ghostCard, ticketList.firstChild);
    });
}

function removeGhostCards() {
    document.querySelectorAll('.ghost-card').forEach(ghost => {
        ghost.remove();
    });
    currentGhostCard = null;
    targetPosition = null;
}

function updateGhostCardPosition(e, ticketList) {
    const ghostCard = ticketList.querySelector('.ghost-card');
    if (!ghostCard) return;
    
    ghostCard.style.display = 'flex';
    currentGhostCard = ghostCard;
    
    // Select both regular and compact ticket cards, excluding the dragging one and ghost card
    const tickets = Array.from(ticketList.querySelectorAll('.ticket-card:not(.dragging):not(.ghost-card), .ticket-card-compact:not(.dragging):not(.ghost-card)'));
    let insertPosition = 0;
    
    // Get the mouse position relative to the ticket list
    const listRect = ticketList.getBoundingClientRect();
    const relativeY = e.clientY - listRect.top;
    
    // Find where to position the ghost card with better accuracy
    for (let i = 0; i < tickets.length; i++) {
        const ticketRect = tickets[i].getBoundingClientRect();
        const ticketTop = ticketRect.top - listRect.top;
        const ticketBottom = ticketTop + ticketRect.height;
        const ticketMiddle = ticketTop + (ticketRect.height / 2);
        
        if (relativeY <= ticketMiddle) {
            insertPosition = i;
            break;
        } else {
            insertPosition = i + 1;
        }
    }
    
    // Move ghost card to the correct position
    if (insertPosition === 0) {
        // Insert at beginning
        if (tickets.length > 0) {
            ticketList.insertBefore(ghostCard, tickets[0]);
        } else {
            ticketList.appendChild(ghostCard);
        }
    } else if (insertPosition >= tickets.length) {
        // Insert at end
        ticketList.appendChild(ghostCard);
    } else {
        // Insert before the ticket at insertPosition
        ticketList.insertBefore(ghostCard, tickets[insertPosition]);
    }
    
    targetPosition = insertPosition;
}

function handleDrop(e) {
    e.preventDefault();
    
    if (!draggedTicket || targetPosition === null) return;
    
    const truckColumn = e.target.closest('.truck-column');
    const pendingColumn = e.target.closest('.pending-column');
    const ticketList = truckColumn ? truckColumn.querySelector('.ticket-list') : 
                      pendingColumn ? pendingColumn.querySelector('.ticket-list') : null;
    
    if (truckColumn && ticketList) {
        const truckId = truckColumn.dataset.truckId;
        const ticketId = draggedTicket.dataset.ticketId;
        const sourceTruckId = draggedTicket.closest('.truck-column')?.dataset.truckId;
        const sourcePendingColumn = draggedTicket.closest('.pending-column');
        
        // Use the targetPosition from the ghost card
        const routePosition = targetPosition;
        
        // If moving within the same truck, handle reordering
        if (sourceTruckId === truckId) {
            reorderTicketInTruck(ticketId, truckId, routePosition);
        } else {
            // Assign ticket to different truck (from pending or different truck)
            assignTicketToTruck(ticketId, truckId, routePosition);
        }
    } else if (pendingColumn) {
        const sourcePendingColumn = draggedTicket.closest('.pending-column');
        
        // Only allow dropping tickets back to pending from trucks, not reordering within pending
        if (!sourcePendingColumn) {
            // Move ticket back to pending from a truck
            const ticketId = draggedTicket.dataset.ticketId;
            moveTicketToPending(ticketId);
        }
        // If source is pending column, ignore the drop (no reordering in pending)
    }
}

function assignTicketToTruck(ticketId, truckId, routePosition) {
    const data = {
        ticket_id: ticketId,
        truck_id: truckId,
        scheduled_date: new Date(currentDate + 'T09:00:00').toISOString(),
        route_position: routePosition
    };
    
    fetch('/api/tickets/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadJobBoard(); // Refresh the entire board
        } else {
            alert('Error assigning ticket: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to assign ticket');
    });
}

function reorderTicketInTruck(ticketId, truckId, newPosition) {
    const data = {
        ticket_id: ticketId,
        truck_id: truckId,
        route_position: newPosition,
        scheduled_date: new Date(currentDate + 'T09:00:00').toISOString()
    };
    
    fetch('/api/tickets/reorder-route', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadJobBoard(); // Refresh the entire board
        } else {
            alert('Error reordering ticket: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to reorder ticket');
    });
}

function moveTicketToPending(ticketId) {
    const data = {
        ticket_id: ticketId,
        truck_id: null,
        scheduled_date: null,
        route_position: null
    };
    
    fetch('/api/tickets/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadJobBoard(); // Refresh the entire board
        } else {
            alert('Error moving ticket to pending: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to move ticket to pending');
    });
}

// Team Assignment Functions
function openTeamModal(truckId, truckNumber) {
    currentTruckId = truckId;
    document.getElementById('modal-truck-name').textContent = truckNumber;
    document.getElementById('modal-date').textContent = new Date(currentDate).toLocaleDateString();
    
    // Pre-select current assignment
    const teamSelect = document.getElementById('team-member-select');
    if (teamAssignments[truckId]) {
        teamSelect.value = teamAssignments[truckId].id;
    } else {
        teamSelect.value = '';
    }
    
    document.getElementById('team-assignment-modal').style.display = 'block';
}

function closeTeamModal() {
    document.getElementById('team-assignment-modal').style.display = 'none';
    currentTruckId = null;
}

function saveTeamAssignment() {
    const memberId = document.getElementById('team-member-select').value;
    const memberName = document.getElementById('team-member-select').selectedOptions[0].text;
    
    if (currentTruckId) {
        // Save to database
        const assignmentData = {
            truck_id: currentTruckId,
            team_member_id: memberId || null,
            assignment_date: currentDate
        };
        
        fetch('/api/team-assignments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(assignmentData)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Update local cache
                if (memberId) {
                    teamAssignments[currentTruckId] = {
                        id: memberId,
                        name: memberName
                    };
                } else {
                    delete teamAssignments[currentTruckId];
                }
                
                // Update the display
                const truckColumn = document.querySelector(`[data-truck-id="${currentTruckId}"]`);
                const teamDisplay = teamAssignments[currentTruckId] ? 
                    `Assigned: ${teamAssignments[currentTruckId].name}` : 
                    'Click to assign team member';
                truckColumn.querySelector('.team-assignment').textContent = teamDisplay;
                
                closeTeamModal();
            } else {
                alert('Error saving team assignment: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to save team assignment');
        });
    }
}

// Click vs Drag Detection Functions
function handleCardMouseDown(e) {
    mouseDownTime = Date.now();
    mouseDownPos = {x: e.clientX, y: e.clientY};
    isDragging = false;
}

function handleCardMouseUp(e) {
    const timeDiff = Date.now() - mouseDownTime;
    const distance = Math.sqrt(
        Math.pow(e.clientX - mouseDownPos.x, 2) + 
        Math.pow(e.clientY - mouseDownPos.y, 2)
    );
    
    // If it was a short time and small movement, treat as click
    isDragging = timeDiff > 200 || distance > 10;
}

function handleCardClick(e) {
    // Don't trigger click if it was a drag operation
    if (isDragging) {
        return;
    }
    
    // Don't trigger if clicking on action buttons
    if (e.target.classList.contains('btn-compact-action') || 
        e.target.classList.contains('priority-badge')) {
        return;
    }
    
    const ticketId = e.currentTarget.dataset.ticketId;
    
    // Navigate directly to the ticket detail page
    window.location.href = `/ticket/${ticketId}`;
}

// Truck Map Functions
let currentMapTruckId = null;
let truckMap = null;
let mapMarkers = [];

function openTruckMap(truckId, truckNumber) {
    console.log('Opening truck map for:', truckNumber, 'ID:', truckId);
    currentMapTruckId = truckId;
    
    // Update modal title and date
    document.getElementById('map-truck-name').textContent = truckNumber;
    document.getElementById('summary-date').textContent = currentDate;
    
    // Show modal
    document.getElementById('truck-map-modal').style.display = 'flex';
    
    // Initialize map with longer delay to ensure modal is visible
    setTimeout(() => {
        console.log('Initializing map...');
        try {
            initializeTruckMap(truckId);
        } catch (error) {
            console.error('Error initializing map:', error);
            document.getElementById('truck-map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e74c3c;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div>Error loading map: ${error.message}</div>
                    </div>
                </div>
            `;
        }
    }, 300);
}

function closeTruckMapModal() {
    document.getElementById('truck-map-modal').style.display = 'none';
    currentMapTruckId = null;
    
    // Clear and remove map
    if (truckMap) {
        truckMap.remove();
        truckMap = null;
        mapMarkers = [];
    }
}

function initializeTruckMap(truckId) {
    console.log('Initializing truck map for truck ID:', truckId);
    console.log('Available trucks:', trucks);
    console.log('Team assignments:', teamAssignments);
    
    // Get truck info from global trucks array
    const truckInfo = trucks.find(t => t.id == truckId);
    const assignedTeamMember = teamAssignments[truckId];
    
    // Fetch the detailed ticket data for this truck from the API
    fetch(`/api/job-board?date=${currentDate}`)
        .then(response => response.json())
        .then(data => {
            const truckTickets = data.truck_schedules[truckId] || [];
            console.log('Fetched truck tickets:', truckTickets);
            
            // Continue with map initialization
            initializeMapWithTickets(truckInfo, assignedTeamMember, truckTickets);
        })
        .catch(error => {
            console.error('Error fetching ticket data:', error);
            // Fallback to simpler map
            initializeMapWithTickets(truckInfo, assignedTeamMember, []);
        });
}

function initializeMapWithTickets(truckInfo, assignedTeamMember, truckTickets) {
    
    console.log('Truck tickets from database:', truckTickets.length);
    console.log('Truck info:', truckInfo);
    console.log('Assigned team member:', assignedTeamMember);
    
    // Use tickets from database (already sorted by route_position in the API)
    // The API endpoint sorts by route_position which is updated by drag & drop
    const orderedTickets = truckTickets;
    
    console.log('Using database order - tickets are already sorted by route_position:', orderedTickets);
    
    // Clear the map container
    const mapContainer = document.getElementById('truck-map');
    if (!mapContainer) {
        throw new Error('Map container not found');
    }
    mapContainer.innerHTML = '';
    
    // Check if Leaflet is available
    if (typeof L === 'undefined') {
        throw new Error('Leaflet library not loaded');
    }
    
    console.log('Creating Leaflet map...');
    // Initialize Leaflet map centered on Pewee Valley, KY
    truckMap = L.map('truck-map').setView([38.3148, -85.4569], 11);
    
    // Add satellite imagery tiles using Esri World Imagery
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    }).addTo(truckMap);
    
    // Clear existing markers
    mapMarkers.forEach(marker => marker.remove());
    mapMarkers = [];
    
    // Array to track all points for map bounds
    const allPoints = [];
    
    // 1. Add TrueTank Office marker
    const officeCoords = [38.3148, -85.4569];
    const officeMarker = L.marker(officeCoords, {
        icon: L.divIcon({
            className: 'office-marker',
            html: '<div style="background: #27ae60; color: white; border-radius: 8px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 16px;">üè¢</div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })
    }).addTo(truckMap);
    
    officeMarker.bindPopup('<b>üè¢ TrueTank Main Office</b><br>123 Main Street<br>Pewee Valley, KY 40056<br><i>Depot & Headquarters</i>');
    mapMarkers.push(officeMarker);
    allPoints.push(officeCoords);
    
    // 2. Add team member home location (if assigned)
    if (assignedTeamMember) {
        const teamMemberCoords = getTeamMemberHomeCoords(assignedTeamMember.name);
        const teamMarker = L.marker(teamMemberCoords, {
            icon: L.divIcon({
                className: 'team-marker',
                html: '<div style="background: #9b59b6; color: white; border-radius: 8px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 14px;">üë§</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(truckMap);
        
        teamMarker.bindPopup(`<b>üë§ ${assignedTeamMember.name}</b><br>Team Member Home<br><i>Assigned to ${truckInfo.truck_number}</i>`);
        mapMarkers.push(teamMarker);
        allPoints.push(teamMemberCoords);
    }
    
    // 3. Add current truck location (simulated - parked at equipment storage)
    const truckCoords = [38.3125, -85.4580]; // Equipment storage location
    const truckMarker = L.marker(truckCoords, {
        icon: L.divIcon({
            className: 'truck-marker',
            html: `<div style="background: #3498db; color: white; border-radius: 8px; width: 36px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 16px;">üöõ</div>`,
            iconSize: [36, 30],
            iconAnchor: [18, 15]
        })
    }).addTo(truckMap);
    
    truckMarker.bindPopup(`<b>üöõ ${truckInfo.truck_number}</b><br>${truckInfo.make} ${truckInfo.model}<br>Equipment Storage<br><i>Current truck location</i>`);
    mapMarkers.push(truckMarker);
    allPoints.push(truckCoords);
    
    // 4. Add job locations for tickets in this truck (numbered by their route_position order from database)
    if (orderedTickets.length > 0) {
        orderedTickets.forEach((ticket, index) => {
            // Use the actual customer address to generate coordinates
            const coords = generateCoordinatesForAddress(ticket.customer_address || '', index);
            allPoints.push(coords);
            
            // Get priority color for the marker
            const priorityColor = getPriorityColor(ticket.priority);
            
            // Create job marker numbered by position in truck column
            const jobMarker = L.marker(coords, {
                icon: L.divIcon({
                    className: 'job-marker',
                    html: `<div style="background: ${priorityColor}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 14px;">${index + 1}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(truckMap);
            
            // Create detailed popup content
            const scheduledTime = ticket.scheduled_date ? 
                new Date(ticket.scheduled_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                'Time TBD';
            
            const popupContent = `
                <div style="min-width: 220px;">
                    <b>üìç Job ${index + 1}: ${scheduledTime}</b><br>
                    <strong>${ticket.job_id}</strong><br>
                    <div style="margin: 8px 0;">
                        <strong>${ticket.service_type}</strong><br>
                        Customer: ${ticket.customer_name || 'Unknown'}<br>
                        Priority: <span style="color: ${priorityColor}; font-weight: bold;">${(ticket.priority || 'medium').toUpperCase()}</span>
                    </div>
                    <div style="font-size: 0.9em; color: #666;">
                        ${ticket.customer_address || 'Address not available'}<br>
                        Duration: ${ticket.estimated_duration || 'TBD'} min
                    </div>
                </div>
            `;
            
            jobMarker.bindPopup(popupContent);
            mapMarkers.push(jobMarker);
        });
        
        // Create route summary with the ordered tickets
        createRouteSummary(orderedTickets);
    } else {
        document.getElementById('route-jobs-list').innerHTML = '<p>No jobs scheduled for this truck today.</p>';
    }
    
    // Fit map to show all points
    if (allPoints.length > 0) {
        const group = new L.featureGroup(mapMarkers.filter(marker => marker.getLatLng));
        truckMap.fitBounds(group.getBounds().pad(0.1));
    }
}

function getTeamMemberHomeCoords(memberName) {
    // Simulate team member home locations around the area
    const teamHomes = {
        'James Wilson': [38.3148, -85.4469],      // Pewee Valley
        'Maria Garcia': [38.2542, -85.7285],      // Louisville  
        'Robert Smith': [38.4048, -85.3716],      // LaGrange
        'Ashley Johnson': [38.3414, -85.4694]     // Crestwood
    };
    
    return teamHomes[memberName] || [38.3148, -85.4569]; // Default to office
}

function generateCoordinatesForAddress(address, index) {
    // Generate realistic coordinates around Pewee Valley, KY area
    // This simulates geocoding - in production you'd use a real geocoding service
    
    const baseCoords = {
        'Pewee Valley': [38.3148, -85.4569],
        'Louisville': [38.2542, -85.7585],
        'LaGrange': [38.4048, -85.3816],
        'Crestwood': [38.3414, -85.4794],
        'Buckner': [38.3503, -85.4630],
        'Prospect': [38.3542, -85.5996],
        'Goshen': [38.4014, -85.5691],
        'Ballardsville': [38.3592, -85.5691]
    };
    
    // Find city in address
    let coords = [38.3148, -85.4569]; // Default to Pewee Valley
    
    if (address) {
        for (const [city, cityCoords] of Object.entries(baseCoords)) {
            if (address.includes(city)) {
                coords = [...cityCoords];
                break;
            }
        }
    }
    
    // Add some random offset to simulate different addresses in the same city
    const offset = 0.02; // About 1-2 miles
    coords[0] += (Math.random() - 0.5) * offset;
    coords[1] += (Math.random() - 0.5) * offset;
    
    return coords;
}

function getPriorityColor(priority) {
    switch (priority) {
        case 'urgent': return '#e74c3c';
        case 'high': return '#f39c12';
        case 'medium': return '#3498db';
        case 'low': return '#95a5a6';
        default: return '#3498db';
    }
}

function createRouteSummary(tickets) {
    const routeJobsList = document.getElementById('route-jobs-list');
    
    if (tickets.length === 0) {
        routeJobsList.innerHTML = '<p>No jobs scheduled for this date.</p>';
        return;
    }
    
    routeJobsList.innerHTML = tickets.map((ticket, index) => {
        const scheduledTime = ticket.scheduled_date ? 
            new Date(ticket.scheduled_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
            'Time TBD';
            
        return `
            <div class="route-job-item priority-${ticket.priority || 'medium'}">
                <div class="job-order">${index + 1}</div>
                <div class="job-details">
                    <div>
                        <span class="job-time">${scheduledTime}</span>
                        <span class="job-service">${ticket.service_type || 'Service'}</span>
                        <span class="job-customer">${ticket.customer_name || ticket.job_id}</span>
                    </div>
                    <div class="job-address">${ticket.customer_address || 'Address not available'}</div>
                </div>
            </div>
        `;
    }).join('');
}


function exportRoute() {
    if (!currentMapTruckId) return;
    
    const truckName = document.getElementById('map-truck-name').textContent;
    
    // Fetch the detailed ticket data for export
    fetch(`/api/job-board?date=${currentDate}`)
        .then(response => response.json())
        .then(data => {
            const truckTickets = data.truck_schedules[currentMapTruckId] || [];
            
            if (truckTickets.length === 0) {
                alert('No jobs to export');
                return;
            }
            
            // Tickets are already sorted by route_position from the API
            // Create detailed export data
            const routeData = truckTickets.map((ticket, index) => {
                const time = ticket.scheduled_date ? 
                    new Date(ticket.scheduled_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                    'Time TBD';
                return `${index + 1}. ${time} - ${ticket.service_type}\\n   Customer: ${ticket.customer_name || 'Unknown'}\\n   Address: ${ticket.customer_address || 'Address not available'}\\n   Job ID: ${ticket.job_id}\\n   Priority: ${(ticket.priority || 'medium').toUpperCase()}`;
            }).join('\\n\\n');
            
            const exportContent = `TrueTank Route Directions\\n${truckName}\\nDate: ${currentDate}\\n\\n${routeData}`;
            
            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${truckName}_Route_${currentDate.replace(/-/g, '')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Route directions exported successfully!');
        })
        .catch(error => {
            console.error('Error fetching data for export:', error);
            alert('Failed to export route - please try again');
        });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const teamModal = document.getElementById('team-assignment-modal');
    const mapModal = document.getElementById('truck-map-modal');
    
    if (event.target === teamModal) {
        closeTeamModal();
    }
    if (event.target === mapModal) {
        closeTruckMapModal();
    }
}
</script>
{% endblock %}

{% block scripts %}
<!-- Custom job board script is included in the template -->
{% endblock %}