{% extends "base.html" %}

{% block title %}{{ 'Edit' if ticket else 'Create' }} Ticket - TrueTank{% endblock %}

{% block content %}
<div class="ticket-form-container">
    <div class="form-header">
        <h2>{{ 'Edit Ticket' if ticket else 'Create New Ticket' }}</h2>
        <div class="form-actions">
            <a href="{{ url_for('job_board') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </div>

    <form id="ticket-form" method="POST">
        <div class="form-grid">
            <!-- Basic Information -->
            <div class="form-section">
                <h3>Basic Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="job_id">Job ID*</label>
                        <input type="text" id="job_id" name="job_id" value="{{ ticket.job_id if ticket else '' }}" {{ 'readonly' if ticket else '' }} required>
                    </div>
                    <div class="form-group">
                        <label for="service_type">Service Type*</label>
                        <select id="service_type" name="service_type" required>
                            <option value="">Select Service Type</option>
                            <option value="Septic Pumping" {{ 'selected' if ticket and ticket.service_type == 'Septic Pumping' else '' }}>Septic Pumping</option>
                            <option value="Septic Inspection" {{ 'selected' if ticket and ticket.service_type == 'Septic Inspection' else '' }}>Septic Inspection</option>
                            <option value="Septic Repair" {{ 'selected' if ticket and ticket.service_type == 'Septic Repair' else '' }}>Septic Repair</option>
                            <option value="Septic Installation" {{ 'selected' if ticket and ticket.service_type == 'Septic Installation' else '' }}>Septic Installation</option>
                            <option value="Preventive Maintenance" {{ 'selected' if ticket and ticket.service_type == 'Preventive Maintenance' else '' }}>Preventive Maintenance</option>
                            <option value="Emergency Service" {{ 'selected' if ticket and ticket.service_type == 'Emergency Service' else '' }}>Emergency Service</option>
                            <option value="Septic Cleaning" {{ 'selected' if ticket and ticket.service_type == 'Septic Cleaning' else '' }}>Septic Cleaning</option>
                            <option value="Line Cleaning/Rooter" {{ 'selected' if ticket and ticket.service_type == 'Line Cleaning/Rooter' else '' }}>Line Cleaning/Rooter</option>
                            <option value="Grease Trap Service" {{ 'selected' if ticket and ticket.service_type == 'Grease Trap Service' else '' }}>Grease Trap Service</option>
                            <option value="Lift Station Service" {{ 'selected' if ticket and ticket.service_type == 'Lift Station Service' else '' }}>Lift Station Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="priority">Priority*</label>
                        <select id="priority" name="priority" required>
                            <option value="low" {{ 'selected' if ticket and ticket.priority == 'low' else '' }}>Low</option>
                            <option value="medium" {{ 'selected' if ticket and ticket.priority == 'medium' else '' }}>Medium</option>
                            <option value="high" {{ 'selected' if ticket and ticket.priority == 'high' else '' }}>High</option>
                            <option value="urgent" {{ 'selected' if ticket and ticket.priority == 'urgent' else '' }}>Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="requested_service_date">Requested Service By</label>
                        <input type="date" id="requested_service_date" name="requested_service_date" value="{{ ticket.requested_service_date.isoformat() if ticket and ticket.requested_service_date else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="status">Status*</label>
                        <select id="status" name="status" required>
                            <option value="pending" {{ 'selected' if ticket and ticket.status == 'pending' else '' }}>Pending</option>
                            <option value="scheduled" {{ 'selected' if ticket and ticket.status == 'scheduled' else '' }}>Scheduled</option>
                            <option value="in-progress" {{ 'selected' if ticket and ticket.status == 'in-progress' else '' }}>In Progress</option>
                            <option value="completed" {{ 'selected' if ticket and ticket.status == 'completed' else '' }}>Completed</option>
                            <option value="cancelled" {{ 'selected' if ticket and ticket.status == 'cancelled' else '' }}>Cancelled</option>
                            <option value="on-hold" {{ 'selected' if ticket and ticket.status == 'on-hold' else '' }}>On Hold</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="service_description">Service Description</label>
                        <textarea id="service_description" name="service_description" rows="3">{{ ticket.service_description if ticket else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Customer & System Selection -->
            <div class="form-section">
                <h3>Customer & System</h3>
                <div class="form-group">
                    <label for="customer_id">Customer*</label>
                    <div class="input-with-button">
                        <select id="customer_id" name="customer_id" required>
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}" {{ 'selected' if ticket and ticket.customer_id == customer.id else '' }}>
                                    {{ customer.first_name }} {{ customer.last_name }}
                                    {% if customer.company_name %} - {{ customer.company_name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="openNewCustomerModal()">+ New</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="septic_system_id">Septic System</label>
                    <div class="input-with-button">
                        <select id="septic_system_id" name="septic_system_id">
                            <option value="">Select System</option>
                            {% for system in septic_systems %}
                                <option value="{{ system.id }}" data-customer-id="{{ system.customer_id }}" {{ 'selected' if ticket and ticket.septic_system_id == system.id else '' }}>
                                    {{ system.system_type }} - {{ system.tank_size }} gal ({{ system.tank_material }})
                                </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="openNewSystemModal()" id="new-system-btn" disabled>+ New</button>
                    </div>
                </div>
            </div>

            <!-- Scheduling -->
            <div class="form-section">
                <h3>Scheduling & Assignment</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="scheduled_date">Scheduled Date & Time</label>
                        <input type="datetime-local" id="scheduled_date" name="scheduled_date" 
                               value="{{ ticket.scheduled_date.strftime('%Y-%m-%dT%H:%M') if ticket and ticket.scheduled_date else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="estimated_duration">Estimated Duration (minutes)</label>
                        <input type="number" id="estimated_duration" name="estimated_duration" min="15" step="15" 
                               value="{{ ticket.estimated_duration if ticket else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="assigned_technician">Assigned Technician</label>
                        <input type="text" id="assigned_technician" name="assigned_technician" 
                               value="{{ ticket.assigned_technician if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="truck_number">Truck Number</label>
                        <input type="text" id="truck_number" name="truck_number" 
                               value="{{ ticket.truck_number if ticket else '' }}">
                    </div>
                </div>
            </div>

            <!-- Pricing -->
            <div class="form-section">
                <h3>Pricing Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="estimated_cost">Estimated Cost</label>
                        <input type="number" id="estimated_cost" name="estimated_cost" min="0" step="0.01" 
                               value="{{ ticket.estimated_cost if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="actual_cost">Actual Cost</label>
                        <input type="number" id="actual_cost" name="actual_cost" min="0" step="0.01" 
                               value="{{ ticket.actual_cost if ticket else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="labor_cost">Labor Cost</label>
                        <input type="number" id="labor_cost" name="labor_cost" min="0" step="0.01" 
                               value="{{ ticket.labor_cost if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="parts_cost">Parts Cost</label>
                        <input type="number" id="parts_cost" name="parts_cost" min="0" step="0.01" 
                               value="{{ ticket.parts_cost if ticket else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="disposal_cost">Disposal Cost</label>
                        <input type="number" id="disposal_cost" name="disposal_cost" min="0" step="0.01" 
                               value="{{ ticket.disposal_cost if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="payment_status">Payment Status</label>
                        <select id="payment_status" name="payment_status">
                            <option value="pending" {{ 'selected' if ticket and ticket.payment_status == 'pending' else '' }}>Pending</option>
                            <option value="paid" {{ 'selected' if ticket and ticket.payment_status == 'paid' else '' }}>Paid</option>
                            <option value="overdue" {{ 'selected' if ticket and ticket.payment_status == 'overdue' else '' }}>Overdue</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Service Details -->
            <div class="form-section">
                <h3>Service Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="gallons_pumped">Gallons Pumped</label>
                        <input type="number" id="gallons_pumped" name="gallons_pumped" min="0" 
                               value="{{ ticket.gallons_pumped if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="waste_type">Waste Type</label>
                        <select id="waste_type" name="waste_type">
                            <option value="">Select Type</option>
                            <option value="domestic" {{ 'selected' if ticket and ticket.waste_type == 'domestic' else '' }}>Domestic</option>
                            <option value="commercial" {{ 'selected' if ticket and ticket.waste_type == 'commercial' else '' }}>Commercial</option>
                            <option value="industrial" {{ 'selected' if ticket and ticket.waste_type == 'industrial' else '' }}>Industrial</option>
                            <option value="grease" {{ 'selected' if ticket and ticket.waste_type == 'grease' else '' }}>Grease</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="disposal_location">Disposal Location</label>
                        <input type="text" id="disposal_location" name="disposal_location" 
                               value="{{ ticket.disposal_location if ticket else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="trip_ticket_number">Trip Ticket Number</label>
                        <input type="text" id="trip_ticket_number" name="trip_ticket_number" 
                               value="{{ ticket.trip_ticket_number if ticket else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="tank_condition">Tank Condition</label>
                        <select id="tank_condition" name="tank_condition">
                            <option value="">Select Condition</option>
                            <option value="excellent" {{ 'selected' if ticket and ticket.tank_condition == 'excellent' else '' }}>Excellent</option>
                            <option value="good" {{ 'selected' if ticket and ticket.tank_condition == 'good' else '' }}>Good</option>
                            <option value="fair" {{ 'selected' if ticket and ticket.tank_condition == 'fair' else '' }}>Fair</option>
                            <option value="poor" {{ 'selected' if ticket and ticket.tank_condition == 'poor' else '' }}>Poor</option>
                            <option value="critical" {{ 'selected' if ticket and ticket.tank_condition == 'critical' else '' }}>Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="equipment_used">Equipment Used</label>
                        <input type="text" id="equipment_used" name="equipment_used" 
                               value="{{ ticket.equipment_used if ticket else '' }}">
                    </div>
                </div>
            </div>

            <!-- Compliance -->
            <div class="form-section">
                <h3>Compliance & Permits</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="permit_required" name="permit_required" value="true" 
                                   {{ 'checked' if ticket and ticket.permit_required else '' }}>
                            Permit Required
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="permit_number">Permit Number</label>
                        <input type="text" id="permit_number" name="permit_number" 
                               value="{{ ticket.permit_number if ticket else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="inspection_required" name="inspection_required" value="true" 
                                   {{ 'checked' if ticket and ticket.inspection_required else '' }}>
                            Inspection Required
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="inspection_passed" name="inspection_passed" value="true" 
                                   {{ 'checked' if ticket and ticket.inspection_passed else '' }}>
                            Inspection Passed
                        </label>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="form-section">
                <h3>Notes & Documentation</h3>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="office_notes">Office Notes</label>
                        <textarea id="office_notes" name="office_notes" rows="3">{{ ticket.office_notes if ticket else '' }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="technician_notes">Technician Notes</label>
                        <textarea id="technician_notes" name="technician_notes" rows="3">{{ ticket.technician_notes if ticket else '' }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="issues_found">Issues Found</label>
                        <textarea id="issues_found" name="issues_found" rows="3">{{ ticket.issues_found if ticket else '' }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="recommendations">Recommendations</label>
                        <textarea id="recommendations" name="recommendations" rows="3">{{ ticket.recommendations if ticket else '' }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="work_performed">Work Performed</label>
                        <textarea id="work_performed" name="work_performed" rows="3">{{ ticket.work_performed if ticket else '' }}</textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="materials_used">Materials Used</label>
                        <textarea id="materials_used" name="materials_used" rows="3">{{ ticket.materials_used if ticket else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-footer">
            <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>
            <button type="submit" class="btn btn-primary">{{ 'Update Ticket' if ticket else 'Create Ticket' }}</button>
        </div>
    </form>
</div>

<style>
.ticket-form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #ecf0f1;
}

.form-header h2 {
    color: #2c3e50;
    margin: 0;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.form-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-section h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ecf0f1;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 600;
    color: #7f8c8d;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.form-group input[type="checkbox"] {
    width: auto;
    margin-right: 0.5rem;
}

.form-group label:has(input[type="checkbox"]) {
    flex-direction: row;
    align-items: center;
    font-weight: 500;
}

.form-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 2rem 0;
    border-top: 1px solid #ecf0f1;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-header {
        flex-direction: column;
        gap: 1rem;
    }
}

.input-with-button {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.input-with-button select {
    flex: 1;
}

.btn-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    white-space: nowrap;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ecf0f1;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #ecf0f1;
}
</style>

<!-- New Customer Modal -->
<div id="newCustomerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Customer</h3>
            <span class="close" onclick="closeNewCustomerModal()">&times;</span>
        </div>
        
        <form id="newCustomerForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="modal_first_name">First Name *</label>
                    <input type="text" id="modal_first_name" name="first_name" required>
                </div>
                <div class="form-group">
                    <label for="modal_last_name">Last Name *</label>
                    <input type="text" id="modal_last_name" name="last_name" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="modal_company_name">Company Name</label>
                    <input type="text" id="modal_company_name" name="company_name">
                </div>
                <div class="form-group">
                    <label for="modal_phone_primary">Phone</label>
                    <input type="tel" id="modal_phone_primary" name="phone_primary">
                </div>
            </div>
            
            <div class="form-group">
                <label for="modal_email">Email</label>
                <input type="email" id="modal_email" name="email">
            </div>
            
            <div class="form-group">
                <label for="modal_property_address">Property Address *</label>
                <input type="text" id="modal_property_address" name="property_address" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="modal_property_city">City *</label>
                    <input type="text" id="modal_property_city" name="property_city" required>
                </div>
                <div class="form-group">
                    <label for="modal_property_state">State *</label>
                    <input type="text" id="modal_property_state" name="property_state" required>
                </div>
                <div class="form-group">
                    <label for="modal_property_zip">ZIP *</label>
                    <input type="text" id="modal_property_zip" name="property_zip" required>
                </div>
            </div>
        </form>
        
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeNewCustomerModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveNewCustomer()">Add Customer</button>
        </div>
    </div>
</div>

<!-- New Septic System Modal -->
<div id="newSystemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Septic System</h3>
            <span class="close" onclick="closeNewSystemModal()">&times;</span>
        </div>
        
        <form id="newSystemForm">
            <input type="hidden" id="modal_customer_id" name="customer_id">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="modal_system_type">System Type *</label>
                    <select id="modal_system_type" name="system_type" required>
                        <option value="">Select Type</option>
                        <option value="conventional">Conventional</option>
                        <option value="aerobic">Aerobic</option>
                        <option value="advanced_treatment">Advanced Treatment</option>
                        <option value="chamber">Chamber</option>
                        <option value="lagoon">Lagoon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal_tank_size">Tank Size (gallons) *</label>
                    <input type="number" id="modal_tank_size" name="tank_size" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="modal_tank_material">Tank Material</label>
                    <select id="modal_tank_material" name="tank_material">
                        <option value="concrete">Concrete</option>
                        <option value="plastic">Plastic</option>
                        <option value="fiberglass">Fiberglass</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modal_num_compartments">Compartments</label>
                    <input type="number" id="modal_num_compartments" name="num_compartments" min="1" max="5" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="modal_access_notes">Access Notes</label>
                <textarea id="modal_access_notes" name="access_notes" rows="3" placeholder="How to access the system, gate codes, etc."></textarea>
            </div>
        </form>
        
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeNewSystemModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveNewSystem()">Add System</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate job ID for new tickets
    if (!document.getElementById('job_id').value) {
        generateJobId();
    }
    
    // Filter septic systems based on customer selection
    const customerSelect = document.getElementById('customer_id');
    const systemSelect = document.getElementById('septic_system_id');
    
    customerSelect.addEventListener('change', function() {
        filterSepticSystems(this.value);
    });
    
    // Initialize with current customer if editing
    if (customerSelect.value) {
        filterSepticSystems(customerSelect.value);
    }
    
    // Form submission
    document.getElementById('ticket-form').addEventListener('submit', handleFormSubmit);
});

function generateJobId() {
    fetch('/api/tickets/next-id')
        .then(response => response.json())
        .then(data => {
            document.getElementById('job_id').value = data.job_id;
        })
        .catch(error => console.error('Error generating job ID:', error));
}

function filterSepticSystems(customerId) {
    const systemSelect = document.getElementById('septic_system_id');
    const options = systemSelect.querySelectorAll('option');
    
    // If no customerId is provided, get it from the customer select
    if (!customerId) {
        const customerSelect = document.getElementById('customer_id');
        customerId = customerSelect.value;
    }
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }
        
        const optionCustomerId = option.getAttribute('data-customer-id');
        if (customerId === '' || optionCustomerId === customerId) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset selection if current selection is not valid for new customer
    const currentSelection = systemSelect.value;
    const currentOption = systemSelect.querySelector(`option[value="${currentSelection}"]`);
    if (currentOption && currentOption.style.display === 'none') {
        systemSelect.value = '';
    }
}

function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const ticketData = {};
    
    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        if (value !== '') {
            ticketData[key] = value;
        }
    }
    
    // Handle checkboxes (they won't be in formData if unchecked)
    ['permit_required', 'inspection_required', 'inspection_passed'].forEach(field => {
        ticketData[field] = formData.has(field);
    });
    
    const ticketId = '{{ ticket.id if ticket else "" }}';
    const isEdit = ticketId !== '';
    const url = isEdit ? `/api/tickets/${ticketId}` : '/api/tickets';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ticketData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(isEdit ? 'Ticket updated successfully!' : 'Ticket created successfully!');
            window.location.href = `/ticket/${data.id}`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the ticket.');
    });
}

// Modal functions for creating new customers and systems
function openNewCustomerModal() {
    document.getElementById('newCustomerModal').style.display = 'block';
}

function closeNewCustomerModal() {
    document.getElementById('newCustomerModal').style.display = 'none';
    document.getElementById('newCustomerForm').reset();
}

function openNewSystemModal() {
    const customerSelect = document.getElementById('customer_id');
    if (!customerSelect.value) {
        alert('Please select a customer first');
        return;
    }
    
    document.getElementById('modal_customer_id').value = customerSelect.value;
    document.getElementById('newSystemModal').style.display = 'block';
}

function closeNewSystemModal() {
    document.getElementById('newSystemModal').style.display = 'none';
    document.getElementById('newSystemForm').reset();
}

function saveNewCustomer() {
    const form = document.getElementById('newCustomerForm');
    const formData = new FormData(form);
    const customerData = {};
    
    for (let [key, value] of formData.entries()) {
        customerData[key] = value;
    }
    
    fetch('/api/customers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(customerData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error creating customer: ' + data.error);
        } else {
            // Add new customer to the select dropdown
            const customerSelect = document.getElementById('customer_id');
            const option = document.createElement('option');
            option.value = data.id;
            option.textContent = `${data.first_name} ${data.last_name}`;
            if (data.company_name) {
                option.textContent += ` - ${data.company_name}`;
            }
            option.selected = true;
            customerSelect.appendChild(option);
            
            // Enable the "New System" button
            document.getElementById('new-system-btn').disabled = false;
            
            // Update system dropdown to show systems for this customer
            filterSepticSystems(data.id);
            
            closeNewCustomerModal();
            alert('Customer added successfully!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create customer. Please try again.');
    });
}

function saveNewSystem() {
    const form = document.getElementById('newSystemForm');
    const formData = new FormData(form);
    const systemData = {};
    
    for (let [key, value] of formData.entries()) {
        systemData[key] = value;
    }
    
    fetch('/api/septic-systems', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(systemData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error creating septic system: ' + data.error);
        } else {
            // Add new system to the select dropdown
            const systemSelect = document.getElementById('septic_system_id');
            const option = document.createElement('option');
            option.value = data.id;
            option.setAttribute('data-customer-id', data.customer_id);
            option.textContent = `${data.system_type} - ${data.tank_size} gal (${data.tank_material})`;
            option.selected = true;
            systemSelect.appendChild(option);
            
            // Update system visibility - pass the customer ID to show only relevant systems
            const customerSelect = document.getElementById('customer_id');
            filterSepticSystems(customerSelect.value);
            
            closeNewSystemModal();
            alert('Septic system added successfully!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create septic system. Please try again.');
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    const customerModal = document.getElementById('newCustomerModal');
    const systemModal = document.getElementById('newSystemModal');
    
    if (event.target === customerModal) {
        closeNewCustomerModal();
    }
    if (event.target === systemModal) {
        closeNewSystemModal();
    }
}

// Enable/disable "New System" button based on customer selection
document.getElementById('customer_id').addEventListener('change', function() {
    const newSystemBtn = document.getElementById('new-system-btn');
    newSystemBtn.disabled = !this.value;
});
</script>
{% endblock %}